{% extends 'navbar/navbar.html' %}
{% load static %}
{% load icon %}

{% block page_content %}

    <div class="columns is-gapless" style="height: 100vh; margin: 0;"> 

        <div class="column is-one-quarter">
            <div class="box" style="height: 100%; display: flex; flex-direction: column; margin: 0; border-radius: 6px 0 0 6px;">
                <div class="has-background p-4" style="border-bottom: 1px solid #dbdbdb;">
                    <h4 class="title is-5 mb-3">Conversas</h4>
                    
                    <div class="field">
                        <p class="control has-icons-left">
                            <input class="input is-small is-rounded" 
                                type="text" 
                                placeholder="Buscar usuário..."
                                name="search"
                                id="user-search-input"
                                
                                hx-get="{% url 'user_list' %}"
                                hx-target="#user-list-container"
                                hx-trigger="keyup changed delay:300ms, search"
                                hx-indicator="#user-list-loading">
                            <span class="icon is-small is-left">
                                <i class="fas fa-search"></i>
                            </span>
                        </p>
                    </div>
                    </div>
                
                <div id="user-list-container" 
                    style="flex: 1; overflow-y: auto;">
                    
                    <div id="user-list-loading" class="htmx-indicator has-text-centered p-6" style="display: none;">
                        <button class="button is-loading is-large is-ghost"></button>
                        <p class="mt-2">Buscando...</p>
                    </div>
                    
                    <div id="user-list"
                        hx-get="{% url 'user_list' %}"
                        hx-trigger="load, every 4s"
                        hx-target="this"
                        hx-swap="innerHTML">
                        <div class="has-text-centered p-6">
                            <button class="button is-loading is-large is-ghost"></button>
                            <p class="mt-2">Carregando usuários...</p>
                        </div>
                    </div>
                    </div>
            </div>
        </div>

        <div class="column">
            <div class="box" style="height: 100%; display: flex; flex-direction: column; margin: 0; border-radius: 0 2px 2px 0;">
                
                <div id="conversation-messages" 
                    class="box chat-container" 
                    style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; margin: 0; border-radius: 0;">
                    <div class="has-text-centered has-text-grey" style="margin-top: 3rem;">
                        <span class="icon is-large has-text-grey-lighter">
                            {% icon "message-circle" %}
                        </span>
                        <p class="mt-4">Selecione um usuário para iniciar uma conversa</p>
                    </div>
                </div>

                <div id="message-form-container" style="display: none;"></div>
            </div>
        </div>
    </div>

<style>
    .box {
        margin: 0 !important;
        border-radius: 0 !important;
    }

    .column .box {
        margin: 0;
        border-radius: 0;
    }

    .message {
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 18px;
        max-width: 70%;
        word-wrap: break-word;
    }

    .message.sent {
        background: #3273dc;
        color: white;
        margin-left: auto;
        margin-right: 0;
    }

    .message.received {
        background: #f5f5f5;
        color: #363636;
        border: 1px solid #dbdbdb;
    }

    .user-item {
        padding: 1rem;
        border-bottom: 1px solid #f5f5f5;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .user-item:hover {
        background-color: #fafafa;
    }

    .user-item.active {
        background-color: #eff5fb;
        border-right: 3px solid #3273dc;
    }

    .unread-badge {
        background: #f14668;
        color: white;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    .last-message-preview {
        font-size: 0.875rem;
        color: #7a7a7a;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
    }

    .user-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .user-details {
        flex: 1;
        min-width: 0;
    }

    .user-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chat-container {
        margin: 0 !important;
        border-radius: 0 !important;
    }
</style>

<script>
    let chatSocket = null;
    let currentUserId = null;

    document.addEventListener('DOMContentLoaded', () => {
        currentUserId = document.querySelector('meta[name="user-id"]').content;
    });

    // Função para Conecta no Websocket
    function connectChatSocket(conversationId) {
        if (chatSocket) chatSocket.close(); // Fecha conexão anterior

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        chatSocket = new WebSocket(`${protocol}//${window.location.host}/ws/chat/${conversationId}/`);

        chatSocket.onopen = () => {
            scrollToBottom(); // Rola para o fim quando conecta
        };

        chatSocket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            
            if (data.type === 'new_message') {
                const isSent = data.sender_id === currentUserId;
                
                // Formata o timestamp (dd/mm/yyyy HH:mm)
                const date = new Date(data.created_at);
                const formattedDate = date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Adiciona mensagem na tela (igual ao template Django)
                document.getElementById('messages-container').insertAdjacentHTML('beforeend', `
                    <div class="message ${isSent ? 'sent' : 'received'}" data-message-id="${data.message_id}">
                        <div class="message-content">
                            ${escapeHtml(data.content)}
                        </div>
                        <div class="is-size-7 has-text-weight-light mt-1" 
                            style="opacity: 0.8; text-align: ${isSent ? 'right' : 'left'};">
                            <span class="icon is-small">
                                <i class="far fa-clock"></i>
                            </span>
                            ${formattedDate}
                        </div>
                    </div>
                `);
                
                scrollToBottom();
            }
        };
    }

    // Função para Enviar Mensagem
    function sendMessage(event) {
        event.preventDefault();
        
        const input = event.target.querySelector('input[name="content"]');
        const content = input.value.trim();
        
        if (content && chatSocket) {
            chatSocket.send(JSON.stringify({
                type: 'chat_message',
                content: content
            }));
            input.value = '';
        }
    }

    // Função para Iniciar Conversa
    function startConversation(userId) {
        fetch(`/chat/conversation/${userId}/`)
            .then(res => res.json())
            .then(data => {
                if (data.conversation_id) {
                    // Carrega o HTML da conversa
                    fetch(`/chat/${data.conversation_id}/`)
                        .then(res => res.text())
                        .then(html => {
                            document.getElementById('conversation-messages').innerHTML = html;
                            
                            // Rola para o fim antes de conectar
                            setTimeout(scrollToBottom, 100);
                            
                            connectChatSocket(data.conversation_id);
                            
                            // Adiciona evento de envio
                            document.querySelector('#conversation-messages form')
                                .addEventListener('submit', sendMessage);
                        });
                }
            });
    }

    // Função para scrollar para baixo ao iniciar uma conversa
    function scrollToBottom() {
        const container = document.getElementById('messages-container');
        if (container) container.scrollTop = container.scrollHeight;
    }

    // Função para evitar XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Função para Fecha conexão ao sair
    window.addEventListener('beforeunload', () => {
        if (chatSocket) chatSocket.close();
    });
</script>
{% endblock %}